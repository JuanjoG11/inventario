<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Bodega | Tenis y Mas</title>

    <link rel="preconnect" href="https://nrlaadaggmpjtdmtntoz.supabase.co">
    <link rel="preconnect" href="https://unpkg.com">

    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="images/logo-tm.png">
</head>

<body class="login-required">
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <img src="images/logo-tm.png" alt="Tennis y Mas" style="width: 120px; margin-bottom: 20px;">
            <h2 style="margin-bottom: 5px;">ACCESO SEDES</h2>
            <p style="opacity: 0.5; font-size: 0.8rem; margin-bottom: 30px;">Introduce el PIN de tu sede</p>

            <div class="pin-input-container">
                <input type="password" id="pinInput" maxlength="4" placeholder="....">
                <button onclick="handleLoginSubmit()" id="loginBtn">AUTORIZAR</button>
            </div>

            <div id="loginError" style="color: var(--color-red); font-size: 0.8rem; margin-top: 15px; display: none;">
                PIN INCORRECTO</div>
        </div>
    </div>
    <div class="app-container">
        <!-- Sidebar for Desktop -->
        <aside class="sidebar">
            <div class="logo-container">
                <img src="images/logo-tm.png" alt="Tennis y Mas" class="logo-img">
            </div>
            <li class="nav-label"
                style="font-size: 0.65rem; color: #444; margin: 20px 0 10px 20px; text-transform: uppercase; font-weight: 800;">
                Principal</li>
            <li><a href="#" onclick="showSection('dashboard', this); return false;" class="nav-link active"><span
                        class="nav-icon">üìä</span> Dashboard</a></li>
            <li><a href="#" onclick="showSection('sales', this); return false;" class="nav-link"><span
                        class="nav-icon">üõí</span> Registrar Venta</a></li>

            <li class="nav-label"
                style="font-size: 0.65rem; color: #444; margin: 20px 0 10px 20px; text-transform: uppercase; font-weight: 800;">
                Gesti√≥n</li>
            <li><a href="#" onclick="showSection('history', this); return false;" class="nav-link"><span
                        class="nav-icon">üìú</span> Historial</a></li>
            <li><a href="#" onclick="showSection('restock', this); return false;" class="nav-link"><span
                        class="nav-icon">üì¶</span> Entradas</a></li>

            <li class="nav-label"
                style="font-size: 0.65rem; color: #444; margin: 20px 0 10px 20px; text-transform: uppercase; font-weight: 800;">
                Reportes</li>
            <li><a href="#" onclick="showSection('analysis', this); return false;" class="nav-link"><span
                        class="nav-icon">üìà</span> An√°lisis</a></li>

            <div style="margin-top: auto; padding: 20px 0;">
                <li><a href="#" onclick="window.logout(); return false;" class="nav-link"
                        style="color: var(--color-red); opacity: 0.7;"><span class="nav-icon">üö™</span> Cerrar
                        Sesi√≥n</a></li>
            </div>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div id="dashboard-section" class="section-fade-in">
                <header class="page-header">
                    <div>
                        <h1>Inventario Central</h1>
                        <p style="opacity: 0.6;">Control de stock real y sincronizado</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div class="active-sede-badge">
                            <i class="nav-icon" style="font-size: 0.9rem;">üìç</i>
                            <span id="activeSedeName"
                                style="font-weight: 800; font-size: 0.85rem; padding-right: 5px;">Cargando...</span>
                            <button onclick="window.logout()"
                                style="background: transparent; border: none; color: var(--color-red); cursor: pointer; padding: 0 5px; font-size: 0.7rem;">(Salir)</button>
                        </div>
                        <div id="connectionStatus"
                            style="font-size: 0.8rem; background: rgba(46, 204, 113, 0.1); color: #2ecc71; padding: 10px 20px; border-radius: 30px; border: 1px solid rgba(46, 204, 113, 0.3); display: flex; align-items: center; gap: 10px; backdrop-filter: blur(10px);">
                            ‚è≥ Iniciando...
                        </div>
                    </div>
                </header>

                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-label">Stock Total</div>
                        <div class="stat-value" id="totalStock">0</div>
                        <div style="font-size: 0.75rem; color: #2ecc71;">Existencias reales</div>
                    </div>
                    <div class="stat-card" style="border-right-color: #3498db;">
                        <div class="stat-label">Ventas Hoy</div>
                        <div class="stat-value" id="totalSales">0</div>
                        <div style="font-size: 0.75rem; color: #888;">Transacciones diarias</div>
                    </div>
                    <div class="stat-card" style="border-right-color: #f39c12;">
                        <div class="stat-label">Stock Bajo</div>
                        <div class="stat-value" id="lowStockCount">0</div>
                        <div style="font-size: 0.75rem; color: #e74c3c;">Revisiones pendientes</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="card" style="padding: 25px; min-height: 300px;">
                        <h3 style="font-size: 0.8rem; margin-bottom: 20px; color: #888;">TENDENCIA DE VENTAS</h3>
                        <div style="height: 200px;"><canvas id="salesTrendChart"></canvas></div>
                    </div>
                    <div class="card" style="padding: 25px; min-height: 300px;">
                        <h3 style="font-size: 0.8rem; margin-bottom: 20px; color: #888;">STOCK POR CATEGOR√çA</h3>
                        <div style="height: 200px;"><canvas id="stockDistributionChart"></canvas></div>
                    </div>
                </div>

                <div class="inventory-controls">
                    <div class="search-wrapper">
                        <span>üîç</span>
                        <input type="text" id="searchInput" class="filter-input"
                            placeholder="Buscar tenis, guayos, tallas...">
                    </div>
                    <select id="sedeFilter" class="form-control"
                        style="width: auto; background: transparent; border: none; font-weight: 700;">
                        <option value="all">TODAS LAS SEDES</option>
                        <option value="Sede Fantasias New York">FANTAS√çAS NEW YORK</option>
                        <option value="Sede Bulevar">BULEVAR</option>
                    </select>
                </div>

                <div id="inventoryGrid" class="inventory-grid">
                    <p style="text-align: center; grid-column: 1/-1; opacity: 0.5; padding: 100px;">Buscando existencias
                        en
                        bodega...</p>
                </div>
            </div>

            <div id="sales-section" style="display:none;" class="section-fade-in">
                <header class="page-header" style="margin-bottom: 25px;">
                    <div>
                        <h1 class="section-title">Registrar Venta</h1>
                        <p style="opacity: 0.6;">Selecciona el producto y registra la salida</p>
                    </div>
                </header>

                <div class="sales-container">
                    <!-- Left: Preview & Search -->
                    <div class="sales-preview-card card">
                        <div class="form-group" style="padding: 24px; margin-bottom: 0;">
                            <label style="font-size: 0.65rem; letter-spacing: 2px;">Buscador Inteligente</label>
                            <div style="position: relative;">
                                <input type="text" id="productSearch" class="form-control"
                                    placeholder="Buscar modelo o marca..." autocomplete="off"
                                    style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem; padding: 20px 25px;">
                                <div id="searchResults" class="search-results"
                                    style="position: absolute; width:100%; top:100%; z-index:150; background: var(--color-gray-dark); border: 1px solid var(--color-gray-lighter); border-radius: 12px; margin-top:10px; max-height:300px; overflow-y:auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display:none;">
                                </div>
                            </div>
                        </div>

                        <div id="productPreview" style="display: none; animation: fadeIn 0.5s ease-out;">
                            <img id="prevImg" src="" class="sales-preview-img">
                            <div style="padding: 25px;">
                                <h2 id="prevName" style="font-size: 1.4rem; font-weight: 800; margin-bottom: 5px;">
                                </h2>
                                <p id="prevCat"
                                    style="color: var(--color-red); font-weight: 900; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px;">
                                </p>
                            </div>
                        </div>

                        <div id="noProductSelected" style="padding: 80px 40px; text-align: center; opacity: 0.2;">
                            <span style="font-size: 4rem;">üîç</span>
                            <p style="margin-top: 15px; font-weight: 700;">Busca un producto para comenzar</p>
                        </div>
                    </div>

                    <!-- Right: Form Details -->
                    <div class="sales-form-card">
                        <form id="saleForm">
                            <div class="sales-form-title">Detalles de la Transacci√≥n</div>

                            <div class="form-group">
                                <label>Punto de Venta</label>
                                <select id="saleSede" class="form-control" required style="padding: 18px 25px;">
                                    <option value="" disabled selected>Seleccione ubicaci√≥n...</option>
                                    <option value="Sede Fantasias New York">Sede Fantasias New York</option>
                                    <option value="Sede Bulevar">Sede Bulevar</option>
                                </select>
                            </div>

                            <div id="productDetails" style="display: none; animation: fadeIn 0.5s ease-out;">
                                <div class="sales-input-group">
                                    <div class="form-group">
                                        <label>Talla Disponible</label>
                                        <select id="saleSize" class="form-control" required style="padding: 18px 25px;">
                                            <option value="" disabled selected>Seleccione...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Cantidad</label>
                                        <input type="number" id="saleQty" class="form-control" value="1" min="1"
                                            required style="padding: 18px 25px;">
                                    </div>
                                </div>

                                <p id="stockAlert"
                                    style="font-size: 0.75rem; color: #888; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 30px; border-left: 3px solid var(--color-red);">
                                </p>

                                <button type="submit" class="btn-primary" id="submitBtn"
                                    style="padding: 22px; font-size: 1rem; letter-spacing: 2px;">
                                    FINALIZAR VENTA
                                </button>
                            </div>

                            <div id="formPlaceholder"
                                style="padding: 60px 0; text-align: center; opacity: 0.3; border: 2px dashed rgba(255,255,255,0.05); border-radius: 20px;">
                                <p>Selecciona un producto y sede para habilitar el formulario</p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Historial Section -->
            <div id="history-section" style="display:none;" class="section-fade-in">
                <header class="page-header">
                    <div>
                        <h1 class="section-title">Historial de Movimientos</h1>
                        <p style="opacity: 0.6;">Registro completo de entradas y salidas</p>
                    </div>
                </header>
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Producto</th>
                                    <th>Talla</th>
                                    <th>Sede</th>
                                    <th>Cant</th>
                                </tr>
                            </thead>
                            <tbody id="historyLogTable">
                                <!-- History items will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Entradas (Restock) Section -->
            <div id="restock-section" style="display:none;" class="section-fade-in">
                <header class="page-header">
                    <div>
                        <h1 class="section-title">Entradas de Mercanc√≠a</h1>
                        <p style="opacity: 0.6;">Aumentar stock por llegada de productos</p>
                    </div>
                </header>
                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <form id="restockForm">
                        <!-- Same structure as sales search but for adding -->
                        <div class="form-group">
                            <label>1. Punto de Recepci√≥n</label>
                            <select id="restockSede" class="form-control" required>
                                <option value="" disabled selected>Seleccione ubicaci√≥n...</option>
                                <option value="Sede Fantasias New York">Sede Fantasias New York</option>
                                <option value="Sede Bulevar">Sede Bulevar</option>
                            </select>
                        </div>
                        <div class="form-group product-search" style="position: relative;">
                            <label>2. Producto a Ingresar</label>
                            <input type="text" id="restockSearch" class="form-control" placeholder="Buscar modelo...">
                            <div id="restockResults" class="search-results"
                                style="display:none; position: absolute; width:100%; z-index:50; background: var(--color-gray-light); border-radius: 12px; margin-top:5px; max-height:200px; overflow-y:auto;">
                            </div>
                        </div>
                        <div id="restockDetails"
                            style="display:none; border-top: 1px dashed #333; padding-top:20px; margin-top:20px;">
                            <div class="form-group">
                                <label>3. Talla</label>
                                <select id="restockSize" class="form-control" required></select>
                            </div>
                            <div class="form-group">
                                <label>4. Cantidad a Ingresar</label>
                                <input type="number" id="restockQty" class="form-control" value="1" min="1" required>
                            </div>
                            <button type="submit" class="btn-primary" id="restockSubmitBtn">Cargar al
                                Inventario</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- An√°lisis Section -->
            <div id="analysis-section" style="display:none;" class="section-fade-in">
                <header class="page-header">
                    <div>
                        <h1 class="section-title">An√°lisis de Negocio</h1>
                        <p style="opacity: 0.6;">Rendimiento y predicciones de stock</p>
                    </div>
                </header>
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-label">Ventas Totales (Mes)</div>
                        <div class="stat-value" id="totalSalesMonth">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rotaci√≥n de Inventario</div>
                        <div class="stat-value">Alta</div>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="card">
                        <h3 style="margin-bottom: 20px; font-size: 0.9rem;">TOP 5 M√ÅS VENDIDOS</h3>
                        <div id="topProductsList" style="display: flex; flex-direction: column; gap: 15px;">
                            <!-- List injected here -->
                        </div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 20px; font-size: 0.9rem;">VENTAS POR SEDE</h3>
                        <canvas id="sedeSalesChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation (Improved) -->
    <div class="bottom-nav-container">
        <nav class="bottom-nav">
            <a href="#" onclick="showSection('dashboard', this); return false;"
                class="active"><i>üìä</i><span>Stock</span></a>
            <a href="#" onclick="showSection('sales', this); return false;"><i>üõí</i><span>Vender</span></a>
            <a href="#" onclick="showSection('history', this); return false;"><i>üìú</i><span>Historial</span></a>
            <a href="#" onclick="showSection('analysis', this); return false;"><i>üìà</i><span>An√°lisis</span></a>
        </nav>
    </div>

    <!-- TEMPORARY CLEANUP BUTTON -->
    <button onclick="window.dangerousCleanupDatabase()"
        style="position:fixed; bottom:20px; right:20px; z-index:9999; opacity: 0.3; background:#333; color:white; padding:10px; border:none; border-radius:10px; font-size: 0.6rem; cursor:pointer;">
        üóëÔ∏è LIMPIAR BD
    </button>

    <!-- Production Libraries -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="tennisymas_catalog.js"></script>
    <script src="app.js"></script>
    <div id="toastContainer" class="toast-container"></div>
    <script>
        let salesChart = null, stockChart = null;
        let selectedProduct = null;

        function showSection(sectionId, element) {
            // Sections to manage
            const sections = ['dashboard', 'sales', 'history', 'restock', 'analysis'];

            // Hide all sections
            sections.forEach(id => {
                const el = document.getElementById(id + '-section');
                if (el) el.style.display = 'none';
            });

            // Show target section
            const target = document.getElementById(sectionId + '-section');
            if (target) target.style.display = 'block';

            // Update all nav links (Sidebar + Bottom Nav)
            document.querySelectorAll('.nav-link, .bottom-nav a').forEach(link => {
                link.classList.remove('active');
                // Check if link corresponds to this section
                if (link.getAttribute('onclick')?.includes(`'${sectionId}'`)) {
                    link.classList.add('active');
                }
            });

            // Re-render data if needed
            if (sectionId === 'dashboard') renderDashboard();
            if (sectionId === 'history') renderHistory();
            if (sectionId === 'analysis') {
                renderAnalysis();
                // Trigger resize to fix Chart.js layout issues when section was hidden
                setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
            }

            window.scrollTo(0, 0);
        }

        function renderDashboard() {
            const grid = document.getElementById('inventoryGrid');
            const term = document.getElementById('searchInput').value.toLowerCase();
            const sede = document.getElementById('sedeFilter').value;
            const totalStockEl = document.getElementById('totalStock');
            const lowStockEl = document.getElementById('lowStockCount');
            const salesEl = document.getElementById('totalSales');

            // Calculate metrics
            let totalStock = 0, lowStock = 0;
            currentInventory.forEach(item => {
                const stock = item.stock || 0;
                totalStock += stock;
                if (stock > 0 && stock <= 2) lowStock++;
            });

            if (totalStockEl) totalStockEl.textContent = totalStock;
            if (lowStockEl) lowStockEl.textContent = lowStock;
            if (salesEl) salesEl.textContent = localStorage.getItem('today_sales_count') || '0';

            renderInventoryGrid(currentInventory);
            renderCharts();
        }

        function renderInventoryGrid(inventory) {
            const grid = document.getElementById('inventoryGrid');
            if (!grid) return;
            const term = document.getElementById('searchInput').value.toLowerCase();
            const sede = document.getElementById('sedeFilter').value;

            // Group by Product Name (Consolidated)
            const productsMap = {};
            inventory.forEach(item => {
                const name = item.product_name || "Desconocido";
                const size = (item.size || "").toString();
                const matchesSearch = name.toLowerCase().includes(term) || size.includes(term);
                const matchesSede = sede === 'all' || item.location_name === sede;

                if (matchesSearch && matchesSede) {
                    if (!productsMap[name]) {
                        productsMap[name] = {
                            name: name,
                            category: item.category,
                            image: item.image,
                            stocks: []
                        };
                    }
                    productsMap[name].stocks.push(item);
                }
            });

            const productsArray = Object.values(productsMap);

            if (productsArray.length === 0) {
                grid.innerHTML = '<div style="text-align: center; grid-column: 1/-1; opacity: 0.5; padding: 100px;">No se encontraron productos.</div>';
                return;
            }

            grid.innerHTML = productsArray.map(p => {
                let imgUrl = p.image || 'images/logo-tm.png';

                // Consolidate sizes (Sum stock across locations)
                const sizeMap = {};
                p.stocks.forEach(s => {
                    const sz = s.size;
                    if (!sizeMap[sz]) sizeMap[sz] = 0;
                    sizeMap[sz] += s.stock;
                });
                const consolidatedSizes = Object.entries(sizeMap)
                    .map(([size, stock]) => ({ size: parseFloat(size), stock }))
                    .sort((a, b) => a.size - b.size);

                return `
                    <div class="product-card">
                        <div class="card-img-container">
                            <span class="card-category">${p.category || 'Calzado'}</span>
                            <img src="${imgUrl}" alt="${p.name}" class="card-img" onerror="this.onerror=null; this.src='images/logo-tm.png'">
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">${p.name}</h3>
                            <div class="stock-badges">
                                ${consolidatedSizes.map(s => `
                                    <div class="badge ${s.stock <= 0 ? 'out' : (s.stock <= 2 ? 'low' : '')}" style="display: flex; gap: 5px; align-items: center;">
                                        <b style="font-size: 1rem;">${s.size}</b> 
                                        <span style="opacity: 0.7;">| ${s.stock} unds</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCharts() {
            const ctxSales = document.getElementById('salesTrendChart')?.getContext('2d');
            const ctxStock = document.getElementById('stockDistributionChart')?.getContext('2d');
            if (!ctxSales || !ctxStock) return;

            // Stock by category
            const categories = {};
            // Use currentInventory but group by product-level categories
            const prodStockMap = {};
            currentInventory.forEach(item => {
                const cat = item.category || 'Otros';
                categories[cat] = (categories[cat] || 0) + (item.stock || 0);
            });

            const labels = Object.keys(categories);
            const dataValues = Object.values(categories);

            // Filter out 0 stock categories for cleaner chart if needed, 
            // but usually better to show all top ones

            if (stockChart) stockChart.destroy();
            stockChart = new Chart(ctxStock, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#ff3333', '#cc0000', '#333', '#1e1e1e', '#888'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#888', font: { size: 10 } }
                        }
                    }
                }
            });

            if (salesChart) salesChart.destroy();
            salesChart = new Chart(ctxSales, {
                type: 'line',
                data: {
                    labels: ['08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00'],
                    datasets: [{
                        label: 'Ventas',
                        data: [0, 2, 5, 3, 8, 4, 6],
                        borderColor: '#ff3333',
                        backgroundColor: 'rgba(255,51,51,0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { display: false },
                        x: { ticks: { color: '#444' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderSalesUI() {
            if (selectedProduct) updateSizeOptions();
        }

        // --- History Implementation ---
        function logTransaction(type, product, size, sede, qty) {
            const history = JSON.parse(localStorage.getItem('transaction_history') || '[]');
            const entry = {
                date: new Date().toISOString(),
                type: type, // 'Sale' or 'Entry'
                product: product,
                size: size,
                sede: sede,
                qty: qty
            };
            history.unshift(entry);
            localStorage.setItem('transaction_history', JSON.stringify(history.slice(0, 100))); // Max 100
        }

        function renderHistory() {
            const table = document.getElementById('historyLogTable');
            const history = JSON.parse(localStorage.getItem('transaction_history') || '[]');

            if (history.length === 0) {
                table.innerHTML = '<tr><td colspan="6" style="text-align:center; opacity:0.3; padding:40px;">No hay movimientos registrados</td></tr>';
                return;
            }

            table.innerHTML = history.map(h => `
                <tr>
                    <td><div style="font-size:0.75rem;">${new Date(h.date).toLocaleDateString()}</div><div style="font-size:0.6rem; opacity:0.5;">${new Date(h.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div></td>
                    <td><span class="type-badge ${h.type === 'Venta' ? 'type-sale' : 'type-entry'}">${h.type}</span></td>
                    <td style="font-weight:700;">${h.product}</td>
                    <td>${h.size}</td>
                    <td style="font-size:0.75rem;">${h.sede.replace('Sede ', '')}</td>
                    <td style="font-weight:800; color:${h.type === 'Venta' ? '#e74c3c' : '#2ecc71'}">${h.type === 'Venta' ? '-' : '+'}${h.qty}</td>
                </tr>
            `).join('');
        }

        // --- Analysis Implementation ---
        let sedeChart = null;
        function renderAnalysis() {
            const history = JSON.parse(localStorage.getItem('transaction_history') || '[]');
            const sales = history.filter(h => h.type === 'Venta');

            // Metrics
            document.getElementById('totalSalesMonth').textContent = sales.reduce((acc, curr) => acc + curr.qty, 0);

            // Top Products
            const topMap = {};
            sales.forEach(s => {
                topMap[s.product] = (topMap[s.product] || 0) + s.qty;
            });
            const topList = Object.entries(topMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const listEl = document.getElementById('topProductsList');
            if (topList.length === 0) {
                listEl.innerHTML = '<p style="opacity:0.3; font-size:0.8rem;">Sin datos suficientes</p>';
            } else {
                listEl.innerHTML = topList.map(([name, qty], i) => `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-weight:900; color:var(--color-red); opacity:${1 - i * 0.2}">#${i + 1}</span>
                            <span style="font-size:0.85rem; font-weight:600;">${name}</span>
                        </div>
                        <span style="font-weight:800; font-size:0.8rem;">${qty} unds</span>
                    </div>
                `).join('');
            }

            // Sede Chart
            const ctx = document.getElementById('sedeSalesChart')?.getContext('2d');
            if (ctx) {
                const sedeMap = {};
                sales.forEach(s => {
                    sedeMap[s.sede] = (sedeMap[s.sede] || 0) + s.qty;
                });

                if (sedeChart) sedeChart.destroy();
                sedeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(sedeMap).map(s => s.replace('Sede ', '')),
                        datasets: [{
                            label: 'Ventas',
                            data: Object.values(sedeMap),
                            backgroundColor: 'rgba(255, 51, 51, 0.5)',
                            borderColor: '#ff3333',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#888' } },
                            y: { grid: { display: false }, ticks: { color: '#888' } }
                        }
                    }
                });
            }
        }

        // --- Sales & Restock Shared Logic ---
        function selectProduct(id, section = 'sales') {
            const prod = allProducts.find(p => p.id == id);
            if (section === 'sales') {
                selectedProduct = prod;
                document.getElementById('productSearch').value = selectedProduct.name;
                document.getElementById('searchResults').style.display = 'none';

                // Show form parts
                document.getElementById('noProductSelected').style.display = 'none';
                document.getElementById('productPreview').style.display = 'block';

                document.getElementById('prevName').textContent = selectedProduct.name;
                document.getElementById('prevCat').textContent = selectedProduct.category || 'Deportivo';
                document.getElementById('prevImg').src = selectedProduct.image || (selectedProduct.images && selectedProduct.images[0]) || 'images/logo-tm.png';

                updateFormVisibility();
                updateSizeOptions();
            } else {
                window.selectedRestockProduct = prod;
                document.getElementById('restockSearch').value = prod.name;
                document.getElementById('restockResults').style.display = 'none';
                document.getElementById('restockDetails').style.display = 'block';

                const sizeSelect = document.getElementById('restockSize');
                sizeSelect.innerHTML = prod.sizes.map(s => `<option value="${s}">${s}</option>`).join('');
            }
        }

        function updateSizeOptions() {
            const sede = document.getElementById('saleSede').value;
            const sizeSelect = document.getElementById('saleSize');
            const alertText = document.getElementById('stockAlert');

            if (!sede || !selectedProduct) return;

            const available = currentInventory.filter(i =>
                i.product_name === selectedProduct.name &&
                i.location_name === sede
            );

            if (available.length === 0) {
                sizeSelect.innerHTML = '<option value="" disabled selected>Sin stock registrado</option>';
                alertText.textContent = "‚ö†Ô∏è Este producto no tiene existencias en esta sede seleccionada.";
                alertText.style.color = "var(--color-red)";
            } else {
                sizeSelect.innerHTML = '<option value="" disabled selected>Seleccione talla...</option>' +
                    available.map(i => `<option value="${i.size}">${i.size} (Stock: ${i.stock})</option>`).join('');
                alertText.textContent = "üí° Tallas detectadas. Selecciona una para descontar.";
                alertText.style.color = "#888";
            }
        }

        // --- Notification System ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'üîî'}</span>
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            // Remove after 4s
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    if (toast.parentNode) toast.remove();
                }, 400);
            }, 4000);
        }

        function changeActiveProfile(newId) {
            activeLocationId = parseInt(newId);
            localStorage.setItem('active_location_id', newId);

            // Sync the Sales selector too if it exists
            const saleSede = document.getElementById('saleSede');
            if (saleSede) saleSede.value = newId;

            showToast(`Perfil cambiado a: ${locations.find(l => l.id == newId).name}`, 'info');

            // Reload inventory data with the new location focus
            fetchInventory();
        }

        async function handleLoginSubmit() {
            const pinInput = document.getElementById('pinInput');
            const pin = pinInput.value;
            const success = await window.verifyPin(pin);
            if (!success) {
                const err = document.getElementById('loginError');
                err.style.display = 'block';
                pinInput.value = '';
                setTimeout(() => err.style.display = 'none', 3000);
            }
        }

        function populateProfileSelectors() {
            const sedeNameEl = document.getElementById('activeSedeName');
            const saleSelect = document.getElementById('saleSede');

            const currentSede = locations.find(l => l.id == activeLocationId);
            if (sedeNameEl && currentSede) {
                sedeNameEl.textContent = currentSede.name.toUpperCase();
            }

            if (saleSelect) {
                // Fixed to current sede - no switching allowed after login for security
                saleSelect.innerHTML = `<option value="${activeLocationId}" selected>${currentSede ? currentSede.name : 'Sede Autorizada'}</option>`;
                saleSelect.disabled = true;
            }
        }
        function updateFormVisibility() {
            const sede = document.getElementById('saleSede').value;
            const details = document.getElementById('productDetails');
            const placeholder = document.getElementById('formPlaceholder');

            if (sede && selectedProduct) {
                details.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                details.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Reset daily sales counter
            const today = new Date().toLocaleDateString();
            if (localStorage.getItem('last_sale_date') !== today) {
                localStorage.setItem('today_sales_count', '0');
                localStorage.setItem('last_sale_date', today);
            }

            populateProfileSelectors();

            // Login Enter Key support
            document.getElementById('pinInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLoginSubmit();
            });

            init().then(() => {
                document.getElementById('searchInput').addEventListener('input', renderDashboard);
                // SedeFilter is now replaced by the header switcher or unified view, but keep listener for compatibility if still present
                if (document.getElementById('sedeFilter')) {
                    document.getElementById('sedeFilter').addEventListener('change', renderDashboard);
                }
                document.getElementById('saleSede').addEventListener('change', () => {
                    updateFormVisibility();
                    updateSizeOptions();
                });

                // Add sales listeners
                const searchInput = document.getElementById('productSearch');
                const results = document.getElementById('searchResults');
                const sedeSelect = document.getElementById('saleSede');

                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        if (term.length < 2) {
                            results.style.display = 'none';
                            return;
                        }

                        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term));
                        if (filtered.length > 0) {
                            results.innerHTML = filtered.map(p => `
                                <div class="search-result-item" onclick="selectProduct(${p.id})" style="padding: 12px 20px; border-bottom: 1px solid var(--color-gray-lighter); cursor: pointer;">
                                    <div style="font-weight: 700;">${p.name}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.5;">${p.category || 'Deportivo'}</div>
                                </div>
                            `).join('');
                            results.style.display = 'block';
                        } else {
                            results.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.5;">No se encontraron productos</div>';
                            results.style.display = 'block';
                        }
                    });
                }

                if (sedeSelect) {
                    sedeSelect.addEventListener('change', () => {
                        if (selectedProduct) updateSizeOptions();
                    });
                }

                const saleForm = document.getElementById('saleForm');
                if (saleForm) {
                    saleForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const sede = document.getElementById('saleSede').value;
                        const size = document.getElementById('saleSize').value;
                        const qty = parseInt(document.getElementById('saleQty').value);

                        if (!selectedProduct) return alert('Selecciona un producto primero');

                        const btn = document.getElementById('submitBtn');
                        btn.disabled = true;
                        btn.textContent = 'Actualizando...';

                        const loc = locations.find(l => l.name === sede);
                        if (!loc) return alert('Sede no v√°lida');

                        const success = await registerSale(selectedProduct.id, loc.id, size, qty);

                        if (success) {
                            logTransaction('Venta', selectedProduct.name, size, sede, qty);

                            const log = document.getElementById('salesLog');
                            if (log && log.innerHTML.includes('No hay registros')) log.innerHTML = '';

                            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            if (log) {
                                log.insertAdjacentHTML('afterbegin', `
                                    <div style="background: var(--color-gray); padding: 12px; border-radius: 10px; border-left: 3px solid #e74c3c;">
                                        <div style="font-size: 0.8rem; font-weight: 700;">-${qty} | ${selectedProduct.name}</div>
                                        <div style="font-size: 0.7rem; opacity: 0.5;">Talla ${size} | ${sede.split('Sede ')[1] || sede} | ${time}</div>
                                    </div>
                                `);
                            }

                            showToast('Venta registrada con √©xito');

                            // Full Reset
                            saleForm.reset();
                            selectedProduct = null;
                            document.getElementById('productSearch').value = '';
                            document.getElementById('productPreview').style.display = 'none';
                            document.getElementById('productDetails').style.display = 'none';
                            document.getElementById('noProductSelected').style.display = 'block';
                            document.getElementById('formPlaceholder').style.display = 'block';

                            renderDashboard();
                        }

                        btn.disabled = false;
                        btn.textContent = 'Confirmar Transacci√≥n';
                    });
                }

                // --- RESTOCK LOGIC ---
                const restockSearch = document.getElementById('restockSearch');
                const restockResults = document.getElementById('restockResults');

                if (restockSearch) {
                    restockSearch.addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        if (term.length < 2) { restockResults.style.display = 'none'; return; }
                        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term));
                        restockResults.innerHTML = filtered.map(p => `
                            <div class="search-result-item" onclick="selectProduct(${p.id}, 'restock')" style="padding: 10px 15px; cursor: pointer; border-bottom:1px solid #222;">
                                <strong>${p.name}</strong>
                            </div>
                        `).join('');
                        restockResults.style.display = 'block';
                    });
                }

                const restockForm = document.getElementById('restockForm');
                if (restockForm) {
                    restockForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const sede = document.getElementById('restockSede').value;
                        const size = document.getElementById('restockSize').value;
                        const qty = parseInt(document.getElementById('restockQty').value);
                        const prod = window.selectedRestockProduct;

                        const btn = document.getElementById('restockSubmitBtn');
                        btn.disabled = true;
                        btn.textContent = 'Cargando...';

                        try {
                            const loc = locations.find(l => l.name === sede);
                            // Simple restock: In production would be an upsert or increment
                            if (supabaseClient) {
                                // First check if entry exists
                                const { data: existing } = await supabaseClient.from('inventory').select('stock').eq('product_id', prod.id).eq('location_id', loc.id).eq('size', size).single();

                                const newStock = (existing ? existing.stock : 0) + qty;
                                await supabaseClient.from('inventory').upsert({
                                    product_id: prod.id,
                                    location_id: loc.id,
                                    size: size,
                                    stock: newStock,
                                    updated_at: new Date()
                                });
                            }

                            // Update local
                            const invItem = currentInventory.find(i => i.product_id == prod.id && i.location_id == loc.id && i.size == size);
                            if (invItem) invItem.stock += qty;
                            else {
                                currentInventory.push({
                                    product_id: prod.id, product_name: prod.name, category: prod.category, image: prod.image,
                                    location_id: loc.id, location_name: loc.name, size: size, stock: qty
                                });
                            }

                            logTransaction('Entrada', prod.name, size, sede, qty);
                            showToast('Inventario actualizado con √©xito');
                            renderDashboard();
                            restockForm.reset();
                            document.getElementById('restockDetails').style.display = 'none';
                        } catch (err) {
                            console.error(err);
                            showToast('Error al actualizar inventario', 'error');
                        }
                        btn.disabled = false;
                        btn.textContent = 'Cargar al Inventario';
                    });
                }
            });
        });
    </script>
</body>

</html>